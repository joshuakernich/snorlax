<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Snorlax</title>
	<script type="text/javascript" src="./jq.js"></script>
	<script type="text/javascript" src="./Tone.js"></script>
	<script type="text/javascript">
		$(function(){
			window.setupTone = async function(){
				await Tone.start()

				window.meter = new Tone.Meter();
				window.mic = new Tone.UserMedia().connect(meter);
				window.sampleRate = Tone.getContext().sampleRate;
				window.waveform = new Tone.Waveform();
				
				mic.open().then(() => {
					console.log("mic open");
					window.mic.connect(meter).connect(waveform);
					initApp();
				}).catch(e => {
					console.log("mic not open",e);
				});
			}

			$(document).click(window.setupTone);


			function initApp(){
				
				setInterval(function(){

					let l = window.meter.getValue();
					let isDanger = (l>-30);

					$('h2').text(l.toFixed(2)).attr('danger',isDanger);

					if(isDanger) navigator.vibrate([100, 30, 100, 30, 100, 30, 200, 30, 200, 30, 200, 30, 100, 30, 100, 30, 100]);
				},100)
			}
		})
	</script>
	<style type="text/css">
		body{
			background: black;
			color: white;
			text-align: center;
		}

		h2[danger='true']{
			color:red;
		}
	</style>
</head>
<body>
	<h1>Snorlax</h1>
	<h2></h2>
</body>
</html>